<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>    Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù…ÙˆØ¸ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ </title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #f4f7f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        textarea {
            resize: vertical;
            min-height: 150px;
        }
        th {
            background-color: #0d6efd !important;
            color: white !important;
            text-align: center;
        }
        td {
            vertical-align: middle;
            text-align: center;
        }
        .note-badge {
            background-color: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            display: inline-block;
            margin: 2px;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ù†Ø³Ø® */
        .interactive-cell {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .interactive-cell:hover {
            background-color: #e9ecef !important;
        }
        .interactive-cell:focus {
            background-color: #fff3cd !important;
            outline: 2px solid #ffc107;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        /* Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø³Ø® */
        #toast {
            visibility: hidden;
            min-width: 200px;
            background-color: #28a745;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 12px;
            position: fixed;
            z-index: 1000;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
        }
        .stats-card {
            background-color: #e2f0d9;
            border-left: 5px solid #28a745;
            padding: 15px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div class="container">
  <h2 class="fw-bold mb-1"><i class="bi bi-shield-fill-check me-2"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡  </h2>
        <p class="mb-0 opacity-90">Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ±Ø² Ø§Ù„Ø¢Ù„ÙŠ ÙˆØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡  </p>
      
    <div class="mb-3">
        <label for="inputText" class="form-label fw-bold">Ù‚Ù… Ø¨Ù„ØµÙ‚ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù‡Ù†Ø§:</label>
        <textarea class="form-control" id="inputText" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..."></textarea>
    </div>

    <div class="d-flex gap-2 justify-content-center mb-4 flex-wrap">
        <button class="btn btn-primary px-4" onclick="analyzeAndBuildTable()">ØªØ­Ù„ÙŠÙ„ ÙˆØ¹Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„</button>
        <button class="btn btn-success px-4" onclick="formatText()">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ ÙƒÙ‚Ø§Ø¦Ù…Ø©</button>
        <button class="btn btn-outline-dark px-3 d-none tool-btn" onclick="exportTableToCSV()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
        <!-- <button class="btn btn-outline-dark px-3 d-none tool-btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button> -->
    </div>

    <div id="dashboard" class="d-none mb-3">
        <div class="row align-items-center">
            <div class="col-md-6 mb-2">
                <div class="stats-card d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-success fw-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <span id="totalAmount">0</span></h5>
                    <h6 class="mb-0 text-secondary">Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª: <span id="totalCount">0</span></h6>
                </div>
            </div>
            <div class="col-md-6 mb-2">
                <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø£Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº..." onkeyup="filterTable()">
            </div>
        </div>
        <p class="text-muted small mt-2 text-center">ğŸ’¡ ØªÙ„Ù…ÙŠØ­: <strong>Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</strong> Ù„Ù„Ù†Ø³Ø® | <strong>Ù†Ù‚Ø±ØªÙŠÙ†</strong> Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ (Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙ)</p>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover d-none" id="resultTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„</th>
                    <th>ØªÙ„ÙÙˆÙ† Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>
</div>

<div id="toast">âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!</div>

<script>
    function normalizeNumbers(text) {
        return text.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
    }

    function splitIntoRecords(rawText) {
        let text = normalizeNumbers(rawText);
        let lines = text.split('\n');
        let records = [];
        let currentRecord = "";

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            if (line === "") {
                if (currentRecord !== "") {
                    records.push(currentRecord);
                    currentRecord = "";
                }
                continue;
            }
            let hasPhone = /7\d{8}/.test(currentRecord);
            let lineHasPhone = /7\d{8}/.test(line);

            if (hasPhone && lineHasPhone) {
                records.push(currentRecord);
                currentRecord = line;
            } else {
                currentRecord += (currentRecord ? " " : "") + line;
            }
        }
        if (currentRecord !== "") records.push(currentRecord);
        return records;
    }

    function parseRecord(recordText) {
        let text = recordText.replace(/[\.\-\(\)]/g, ' ').replace(/\s+/g, ' ').trim();
        let phone = "", amount = "0", name = "", notes = [];

        // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‡Ø§ØªÙ
        let phoneMatch = text.match(/\b(7\d{8})\b/);
        if (phoneMatch) {
            phone = phoneMatch[1];
            text = text.replace(phoneMatch[1], ' ');
        }

        // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø¥Ù„Ù‰ ÙÙ„Ø§Ù†)
        let transferRegex = /(?:\d+(?:[,ØŒ]\d+)?\s*(?:Ø§Ù„Ù|Ø£Ù„Ù)?\s*)?(?:Ø§Ù„Ù‰|Ø¥Ù„Ù‰)\s*([^\s\d]+)/g;
        let tMatch;
        while ((tMatch = transferRegex.exec(text)) !== null) {
            notes.push(tMatch[0]);
            text = text.replace(tMatch[0], ' ');
        }

        // 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¨Ù„Øº
        let amountMatch = text.match(/(?:Ø­ÙˆÙ„Ù‡\s*)?(\d+(?:[,ØŒ]\d+)?)(?:\s*(Ø§Ù„Ù|Ø£Ù„Ù))?/);
        if (amountMatch) {
            let numStr = amountMatch[1].replace(/[,ØŒ]/g, ''); 
            let num = parseFloat(numStr);
            let hasAlf = amountMatch[2] !== undefined || text.includes('Ø§Ù„Ù') || text.includes('Ø£Ù„Ù');
            
            if (hasAlf && num < 1000) num = num * 1000;
            amount = num.toString();
            
            if (amountMatch[0].includes("Ø­ÙˆÙ„Ù‡")) notes.push("Ø­ÙˆÙ„Ù‡");
            text = text.replace(amountMatch[0], ' ');
        }

        // 4. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù… ÙˆØªØµÙÙŠØªÙ‡
        let ignoreWords = ['Ø§Ù„Ù', 'Ø£Ù„Ù', 'ÙŠÙ…Ù†ÙŠ', 'Ø­ÙˆÙ„Ù‡', 'Ø­ÙˆÙ„'];
        let words = text.split(/\s+/).filter(w => w);
        let nameWords = [];
        words.forEach(w => {
            if (/^[\u0600-\u06FF]+$/.test(w) && !ignoreWords.includes(w)) {
                nameWords.push(w);
            } else if (w && !ignoreWords.includes(w)) {
                notes.push(w);
            }
        });

        return {
            amount: amount || "0",
            name: nameWords.join(' ') || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            phone: phone || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            notes: notes
        };
    }

    // Ø²Ø± Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙƒÙ†Øµ
    function formatText() {
        const textarea = document.getElementById('inputText');
        const rawText = textarea.value;
        if (!rawText.trim()) return;

        const records = splitIntoRecords(rawText);
        let formattedText = "";
        records.forEach(record => {
            const data = parseRecord(record);
            let noteStr = data.notes.length > 0 ? ` (Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${data.notes.join(' - ')})` : "";
            formattedText += `${data.amount} - ${data.name} - ${data.phone}${noteStr}\n`;
        });
        textarea.value = formattedText;
    }

    // Ø²Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function analyzeAndBuildTable() {
        const rawText = document.getElementById('inputText').value;
        if (!rawText.trim()) return;

        const records = splitIntoRecords(rawText);
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ""; 

        records.forEach(record => {
            const data = parseRecord(record);
            let notesHtml = data.notes.length > 0 
                ? data.notes.map(n => `<span class="note-badge">${n}</span>`).join('') 
                : '<span class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';

            const row = `<tr>
                <td class="interactive-cell fw-bold text-success amount-cell" title="Ù†Ù‚Ø±Ø© Ù„Ù„Ù†Ø³Ø® | Ù†Ù‚Ø±ØªÙŠÙ† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">${data.amount}</td>
                <td class="interactive-cell fw-bold name-cell" title="Ù†Ù‚Ø±Ø© Ù„Ù„Ù†Ø³Ø® | Ù†Ù‚Ø±ØªÙŠÙ† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">${data.name}</td>
                <td class="interactive-cell text-primary fw-bold phone-cell" dir="ltr" title="Ù†Ù‚Ø±Ø© Ù„Ù„Ù†Ø³Ø® | Ù†Ù‚Ø±ØªÙŠÙ† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">${data.phone}</td>
                <td>${notesHtml}</td>
                <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        document.getElementById('resultTable').classList.remove('d-none');
        document.getElementById('dashboard').classList.remove('d-none');
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('d-none'));
        
        updateTotals();
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø£Ø­Ø¯Ø§Ø« (Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ù‚Ø±Ø©) Ùˆ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ù‚Ø±ØªÙŠÙ†)
    const tableBody = document.getElementById('tableBody');

    // Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ù†Ø³Ø®
    tableBody.addEventListener('click', function(e) {
        if (e.target.classList.contains('interactive-cell')) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ù„ÙŠØ© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ù„Ø§ Ù†Ù†Ø³Ø®
            if (e.target.getAttribute('contenteditable') === 'true') return;
            
            navigator.clipboard.writeText(e.target.innerText.trim()).then(() => {
                showToast();
            });
        }
    });

    // Ù†Ù‚Ø±ØªÙŠÙ† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    tableBody.addEventListener('dblclick', function(e) {
        if (e.target.classList.contains('interactive-cell')) {
            e.target.setAttribute('contenteditable', 'true');
            e.target.focus();
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            document.execCommand('selectAll', false, null);
        }
    });

    // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ù„ÙŠØ© Ø£Ùˆ Ø¶ØºØ· Enter
    tableBody.addEventListener('focusout', saveEdit);
    tableBody.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            e.target.blur(); // Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ focusout
        }
    });

    function saveEdit(e) {
        if (e.target.classList.contains('interactive-cell') && e.target.getAttribute('contenteditable') === 'true') {
            e.target.setAttribute('contenteditable', 'false');
            updateTotals(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ ÙÙŠ Ø­Ø§Ù„ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ù„Øº
        }
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø³Ø®
    function showToast() {
        const toast = document.getElementById("toast");
        toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
    }

    // Ø­Ø°Ù ØµÙ
    function deleteRow(btn) {
        btn.closest('tr').remove();
        updateTotals();
    }

    // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª
    function updateTotals() {
        let total = 0;
        let count = 0;
        const amountCells = document.querySelectorAll('.amount-cell');
        
        amountCells.forEach(cell => {
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø®ÙÙŠØ© (Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«)
            if (cell.closest('tr').style.display !== 'none') {
                let val = parseFloat(cell.innerText.replace(/,/g, ''));
                if (!isNaN(val)) total += val;
                count++;
            }
        });

        document.getElementById('totalAmount').innerText = total.toLocaleString();
        document.getElementById('totalCount').innerText = count;
    }

    // Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function filterTable() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.getElementById("tableBody").getElementsByTagName("tr");

        for (let i = 0; i < rows.length; i++) {
            let rowText = rows[i].innerText.toLowerCase();
            rows[i].style.display = rowText.includes(input) ? "" : "none";
        }
        updateTotals(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ù„Ù Excel (CSV)
    function exportTableToCSV() {
        let csv = '\uFEFF'; // Ù„Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ Ø¥ÙƒØ³Ù„
        const rows = document.querySelectorAll("#resultTable tr");
        
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            
            for (let j = 0; j < cols.length - 1; j++) { // ØªØ¬Ø§Ù‡Ù„ Ø¹Ù…ÙˆØ¯ "Ø¥Ø¬Ø±Ø§Ø¡" (Ø²Ø± Ø§Ù„Ø­Ø°Ù)
                let data = cols[j].innerText.replace(/"/g, '""'); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙÙˆØ§ØµÙ„
                row.push('"' + data + '"');
            }
            if (row.length > 0 && rows[i].style.display !== 'none') {
                csv += row.join(",") + "\n";
            }
        }

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>
