<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>    Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù…ÙˆØ¸ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ </title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-orange: #faa619;
            --brand-green: #1a953e;
            --light-bg: #fdfcfb;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Cairo', sans-serif; 
        font-size: 12px; 
        color:black;  
        margin: 0;
        padding: 0;
        }
        .container {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border-top: 8px solid var(--brand-orange);
        }
        textarea {
            resize: vertical;
            min-height: 150px;
            border-color: #eee;
        }
        textarea:focus {
            border-color: var(--brand-orange) !important;
            box-shadow: 0 0 0 0.25rem rgba(250, 166, 25, 0.25) !important;
        }
        th {
            background-color: var(--brand-green) !important;
            color: white !important;
            text-align: center;
            border-bottom: 3px solid var(--brand-orange) !important;
            position: relative;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ù†Ø³Ø® Ø§Ù„Ø¹Ù…ÙˆØ¯ */
        .copy-col-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 4px;
            font-size: 0.7em;
            margin-right: 5px;
            padding: 2px 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .copy-col-btn:hover {
            background: var(--brand-orange);
        }
        td {
            vertical-align: middle;
            text-align: center;
        }
        .note-badge {
            background-color: var(--brand-orange);
            color: #fff;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            display: inline-block;
            margin: 2px;
            font-weight: 500;
        }
        .interactive-cell {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .interactive-cell:hover {
            background-color: #fff9f0 !important;
            color: var(--brand-orange);
        }
        .interactive-cell:focus {
            background-color: #fff3cd !important;
            outline: 2px solid var(--brand-orange);
        }
        /* --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙ Ø§Ù„Ù…Ø´Ø·ÙˆØ¨ (ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„) --- */
        .completed-row {
            background-color: #f0f0f0 !important;
            color: #999 !important;
            text-decoration: line-through;
        }
        .completed-row .interactive-cell {
            color: #999 !important; /* ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ù„Ù„Ø±Ù…Ø§Ø¯ÙŠ */
        }
        .completed-row .amount-cell {
            color: #999 !important; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± Ù„Ù„Ù…Ø¨Ù„Øº */
            text-decoration: line-through;
        }
        
        #toast {
            visibility: hidden;
            min-width: 200px;
            background-color: var(--brand-green);
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 12px;
            position: fixed;
            z-index: 1000;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
        }
        .stats-card {
            background-color: #f0f9f1;
            border-left: 5px solid var(--brand-green);
            padding: 15px;
            border-radius: 8px;
        }
        .sender-info-box {
            background-color: #fffdf9;
            border: 1px solid #ffeeba;
            border-right: 5px solid var(--brand-orange);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .text-primary { color: var(--brand-orange) !important; }
        .btn-primary { 
            background-color: var(--brand-green) !important; 
            border-color: var(--brand-green) !important; 
        }
        .btn-success { 
            background-color: var(--brand-orange) !important; 
            border-color: var(--brand-orange) !important; 
            color: white !important;
        }
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø«Ø§Ø¨Øª */
.footer-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #ffffff;
    padding: 10px 0;
    text-align: center;
    border-top: 2px solid var(--brand-orange);
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    z-index: 999;
}
.brand-footer {
    color: var(--brand-green);
    font-weight: bold;
    font-size: 0.9em;
}
.dev-footer {
    color: var(--brand-orange);
    font-size: 0.8em;
    margin-top: 2px;
}
/* Ø¥Ø¶Ø§ÙØ© Ù‡Ø§Ù…Ø´ Ø³ÙÙ„ÙŠ Ù„Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„ÙÙˆØªØ± */
body {
    padding-bottom: 70px; 
}
#analyzeBtn {
    transition: all 0.5s ease-in-out;
}
    </style>
</head>
<body onload="loadSavedData()">

<div class="container">
 <h2 class="fw-bold mb-1"><i class="bi bi-shield-fill-check me-2"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡  </h2>
        <p class="mb-0 opacity-90">Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ±Ø² Ø§Ù„Ø¢Ù„ÙŠ ÙˆØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡  </p>
          
<div class="sender-info-box">
    <h5 class="mb-3 fw-bold" style="color: var(--brand-orange)">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ </h5>
    <div class="row g-3">
        <div class="col-md-4">
            <label class="form-label fw-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„:</label>
            <input type="text" id="mainSenderName" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„" list="namesList" oninput="autoFillSenderInfo()">
            <datalist id="namesList"></datalist>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±Ø³Ù„:</label>
<input type="text" id="mainSenderAccount" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨" 
       oninput="this.value = normalizeNumbers(this.value)">            </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±Ø³Ù„:</label>
<input type="text" id="mainSenderPhone" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" 
       oninput="this.value = normalizeNumbers(this.value)">        </div>
    </div>
</div>
    <div class="mb-3">
        <label for="inputText" class="form-label fw-bold">Ù‚Ù… Ø¨Ù„ØµÙ‚ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù‡Ù†Ø§:</label>
        <textarea class="form-control shadow-sm" id="inputText" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..."></textarea>
    </div>

    <div class="d-flex gap-2 justify-content-center mb-4 flex-wrap">
                <button class="btn btn-success px-4 shadow-sm" onclick="formatText()">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ ÙƒÙ‚Ø§Ø¦Ù…Ø©</button>

        <button id="analyzeBtn" class="btn btn-primary px-4 shadow-sm d-none" onclick="analyzeAndBuildTable()">ØªØ­Ù„ÙŠÙ„ ÙˆØ¹Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„</button>
        <button class="btn btn-danger px-4 shadow-sm" onclick="resetPage()">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        
        <button class="btn btn-outline-dark px-3 d-none tool-btn" onclick="exportTableToCSV()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
        
        <button class="btn btn-outline-secondary px-3 d-none tool-btn" onclick="clearHistory()">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button> 
    </div>

    <div id="dashboard" class="d-none mb-3">
        <div class="row align-items-center">
            
            <div class="col-md-6 mb-2">
                <input type="text" id="searchInput" class="form-control form-control-lg border-success" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§..." onkeyup="filterTable()">
            </div>
             <div class="col-md-6 mb-2">
                <div class="stats-card d-flex justify-content-between align-items-center shadow-sm">
                    <h5 class="mb-0 fw-bold" style="color: var(--brand-green)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©): <span id="totalAmount">0</span></h5>
                    <h6 class="mb-0 text-secondary">Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª: <span id="totalCount">0</span></h6>
                </div>
            </div>
        </div>
        <p class="text-muted small mt-2 text-center">ğŸ’¡ ØªÙ„Ù…ÙŠØ­: <strong>Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¨Ø¹</strong> Ù„Ø´Ø·Ø¨ Ø§Ù„Ø­ÙˆØ§Ù„Ø© ÙˆØ®ØµÙ…Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ | <strong>Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</strong> Ù„Ù„Ù†Ø³Ø®</p>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover d-none" id="resultTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø±Ø³Ù„ <button class="copy-col-btn" onclick="copyColumn(0)" title="Ù†Ø³Ø® Ø§Ù„Ø¹Ù…ÙˆØ¯">ğŸ“‹</button></th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ <button class="copy-col-btn" onclick="copyColumn(1)" title="Ù†Ø³Ø® Ø§Ù„Ø¹Ù…ÙˆØ¯">ğŸ“‹</button></th>
                    <th>Ù‡Ø§ØªÙ Ù…. <button class="copy-col-btn" onclick="copyColumn(2)" title="Ù†Ø³Ø® Ø§Ù„Ø¹Ù…ÙˆØ¯">ğŸ“‹</button></th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº <button class="copy-col-btn" onclick="copyColumn(3)" title="Ù†Ø³Ø® Ø§Ù„Ø¹Ù…ÙˆØ¯">ğŸ“‹</button></th>

                    <th>Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„ <button class="copy-col-btn" onclick="copyColumn(4)" title="Ù†Ø³Ø® Ø§Ù„Ø¹Ù…ÙˆØ¯">ğŸ“‹</button></th>
                    <th>ØªÙ„ÙÙˆÙ† Ø§Ù„Ù…Ø³ØªÙ„Ù… <button class="copy-col-btn" onclick="copyColumn(5)" title="Ù†Ø³Ø® Ø§Ù„Ø¹Ù…ÙˆØ¯">ğŸ“‹</button></th>
                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th> 
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>
<footer>
    <div class="footer-container">
    <div class="brand-footer">
       Ø´Ø±ÙƒØ© Ø§Ù„Ø±ÙˆØ¶Ø© Ù„Ù„ØµØ±Ø§ÙØ© ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© -2026 Â© 
    </div>
    <div class="dev-footer">
        ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ±: Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´Ø±ÙÙŠ
    </div>
</div>
</footer>
<div id="toast">âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!</div>

<script>
    // ğŸ›¡ï¸ [ØªØ¹Ø¯ÙŠÙ„ Ø£Ù…Ù†ÙŠ] Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ ÙˆÙ…Ù†Ø¹ Ø«ØºØ±Ø© (XSS) Ø¹Ù†Ø¯ Ù„ØµÙ‚ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®Ø¨ÙŠØ«Ø©
    function escapeHTML(str) {
        if (!str) return "";
        return str.toString().replace(/[&<>'"]/g, 
            tag => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[tag] || tag)
        );
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø§ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ø°ÙƒÙŠ ---
    
    // Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ù‡Ø§ØªÙ (ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„)
    function saveToSenderDatabase() {
        const name = document.getElementById('mainSenderName').value.trim();
        const account = document.getElementById('mainSenderAccount').value.trim();
        const phone = document.getElementById('mainSenderPhone').value.trim();

        if (!name || name === "-" || name === "") return;

        let db = JSON.parse(localStorage.getItem('senderDatabase') || '{}');

        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ø§Ø³Ù…
        db[name] = {
            account: account.replace(' /', ''),
            phone: phone
        };

        localStorage.setItem('senderDatabase', JSON.stringify(db));
        updateDatalists();
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    function autoFillSenderInfo() {
        const nameInput = document.getElementById('mainSenderName').value;
        const db = JSON.parse(localStorage.getItem('senderDatabase') || '{}');
        
        if (db[nameInput]) {
            document.getElementById('mainSenderAccount').value = db[nameInput].account;
            document.getElementById('mainSenderPhone').value = db[nameInput].phone;
        }
    }

    function loadSavedData() {
        updateDatalists();
    }

    function updateDatalists() {
        const db = JSON.parse(localStorage.getItem('senderDatabase') || '{}');
        const namesList = document.getElementById('namesList');
        if (namesList) {
            namesList.innerHTML = Object.keys(db).map(n => `<option value="${escapeHTML(n)}">`).join('');
        }
    }

    function clearHistory() {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ")) {
            localStorage.removeItem('senderDatabase');
            updateDatalists();
            document.getElementById('mainSenderName').value = "";
            document.getElementById('mainSenderAccount').value = "";
            document.getElementById('mainSenderPhone').value = "";
            alert("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­");
        }
    }

    // --- ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø­ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ---
    function resetPage() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ØŸ")) {
            // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            document.getElementById('inputText').value = "";
            document.getElementById('mainSenderName').value = "";
            document.getElementById('mainSenderAccount').value = "";
            document.getElementById('mainSenderPhone').value = "";
            
            // Ù…Ø³Ø­ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            document.getElementById('tableBody').innerHTML = "";
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª
            document.getElementById('resultTable').classList.add('d-none');
            document.getElementById('dashboard').classList.add('d-none');
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.add('d-none'));
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
            updateTotals();
            
            // Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
            document.getElementById("toast").innerText = "ğŸ§¹ ØªÙ… Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            showToast();
        }
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³Ø­
document.getElementById('analyzeBtn').classList.add('d-none');
    }

    // --- ÙˆØ¸ÙŠÙØ© Ù†Ø³Ø® Ø§Ù„Ø¹Ù…ÙˆØ¯ ---
    function copyColumn(index) {
        const rows = document.querySelectorAll("#tableBody tr");
        let colData = [];
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                let cellText = row.cells[index].innerText.replace(' /', '').trim();
                colData.push(cellText);
            }
        });
        if (colData.length > 0) {
            navigator.clipboard.writeText(colData.join('\n')).then(() => {
                const toast = document.getElementById("toast");
                toast.innerText = "âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!";
                showToast();
            });
        }
    }

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ---
    function normalizeNumbers(text) {
        return text.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
    }

    function splitIntoRecords(rawText) {
        let text = normalizeNumbers(rawText);
        let lines = text.split('\n');
        let records = [];
        let currentRecord = "";
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            if (line === "") {
                if (currentRecord !== "") { records.push(currentRecord); currentRecord = ""; }
                continue;
            }
            let hasPhone = /7\d{8}/.test(currentRecord);
            let lineHasPhone = /7\d{8}/.test(line);
            if (hasPhone && lineHasPhone) {
                records.push(currentRecord);
                currentRecord = line;
            } else {
                currentRecord += (currentRecord ? " " : "") + line;
            }
        }
        if (currentRecord !== "") records.push(currentRecord);
        return records;
    }

    function parseRecord(recordText) {
        let text = recordText.replace(/[\.\-\(\)]/g, ' ').replace(/\s+/g, ' ').trim();
        let phone = "", amount = "0", name = "", notes = [];
        let phoneMatch = text.match(/\b(7\d{8})\b/);
        if (phoneMatch) { phone = phoneMatch[1]; text = text.replace(phoneMatch[1], ' '); }

        let transferRegex = /(?:\d+(?:[,ØŒ]\d+)?\s*(?:Ø§Ù„Ù|Ø£Ù„Ù)?\s*)?(?:Ø§Ù„Ù‰|Ø¥Ù„Ù‰)\s*([^\s\d]+)/g;
        let tMatch;
        while ((tMatch = transferRegex.exec(text)) !== null) {
            notes.push(tMatch[0]);
            text = text.replace(tMatch[0], ' ');
        }

        let amountMatch = text.match(/(?:Ø­ÙˆÙ„Ù‡\s*)?(\d+(?:[,ØŒ]\d+)?)(?:\s*(Ø§Ù„Ù|Ø£Ù„Ù))?/);
        if (amountMatch) {
            let numStr = amountMatch[1].replace(/[,ØŒ]/g, ''); 
            let num = parseFloat(numStr);
            let hasAlf = amountMatch[2] !== undefined || text.includes('Ø§Ù„Ù') || text.includes('Ø£Ù„Ù');
            if (hasAlf && num < 1000) num = num * 1000;
            amount = num.toString();
            text = text.replace(amountMatch[0], ' ');
        }

        let ignoreWords = ['Ø§Ù„Ù', 'Ø£Ù„Ù', 'ÙŠÙ…Ù†ÙŠ', 'Ø­ÙˆÙ„Ù‡', 'Ø­ÙˆÙ„'];
        let words = text.split(/\s+/).filter(w => w);
        let nameWords = [];
        words.forEach(w => {
            if (/^[\u0600-\u06FF]+$/.test(w) && !ignoreWords.includes(w)) {
                nameWords.push(w);
            } else if (w && !ignoreWords.includes(w)) {
                notes.push(w);
            }
        });
        return { amount: amount || "0", name: nameWords.join(' ') || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯", phone: phone || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯", notes: notes };
    }

    function formatText() {
        const textarea = document.getElementById('inputText');
        const rawText = textarea.value;
        if (!rawText.trim()) return;
        const records = splitIntoRecords(rawText);
        let formattedText = "";
        records.forEach(record => {
            const data = parseRecord(record);
            let noteStr = data.notes.length > 0 ? ` (Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${data.notes.join(' - ')})` : "";
            formattedText += `${data.amount} - ${data.name} - ${data.phone}${noteStr}\n`;
        });
        textarea.value = formattedText;
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
document.getElementById('analyzeBtn').classList.remove('d-none');
    }

    function analyzeAndBuildTable() {
        const rawText = document.getElementById('inputText').value;
        if (!rawText.trim()) return;

        const mainSender = document.getElementById('mainSenderName').value || "-";
        const mainAcc = document.getElementById('mainSenderAccount').value;
        const mainPhone = document.getElementById('mainSenderPhone').value || "-";
        const formattedAcc = mainAcc ? mainAcc + " /" : "-";

        saveToSenderDatabase();

        const records = splitIntoRecords(rawText);
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ""; 

        records.forEach(record => {
            const data = parseRecord(record);
            
            // ğŸ›¡ï¸ [ØªØ¹Ø¯ÙŠÙ„ Ø£Ù…Ù†ÙŠ] ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù…Ù†Ø¹ Ø«ØºØ±Ø© XSS
            let notesHtml = data.notes.length > 0 
                ? data.notes.map(n => `<span class="note-badge">${escapeHTML(n)}</span>`).join('') 
                : '<span class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';

            // ğŸ›¡ï¸ [ØªØ¹Ø¯ÙŠÙ„ Ø£Ù…Ù†ÙŠ] ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù…Ù†Ø¹ Ø«ØºØ±Ø© XSS
            const row = `<tr>
                <td class="interactive-cell">${escapeHTML(mainSender)}</td>
                <td class="interactive-cell">${escapeHTML(formattedAcc)}</td>
                <td class="interactive-cell text-secondary">${escapeHTML(mainPhone)}</td>
                <td class="interactive-cell fw-bold text-success amount-cell">${escapeHTML(data.amount)}</td>
                <td class="interactive-cell fw-bold name-cell">${escapeHTML(data.name)}</td>
                <td class="interactive-cell text-primary fw-bold phone-cell" dir="ltr">${escapeHTML(data.phone)}</td>
                <td>${notesHtml}</td>
                <td class="text-center">
                    <input type="checkbox" class="form-check-input" style="cursor:pointer; transform: scale(1.3);" onchange="toggleRowStatus(this)" title="Ø­Ø¯Ø¯ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„">
                </td>
                <td><button class="btn btn-sm btn-outline-danger border-0" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        document.getElementById('resultTable').classList.remove('d-none');
        document.getElementById('dashboard').classList.remove('d-none');
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('d-none'));
        updateTotals();
    }

    function toggleRowStatus(checkbox) {
        const row = checkbox.closest('tr');
        if (checkbox.checked) {
            row.classList.add('completed-row');
        } else {
            row.classList.remove('completed-row');
        }
        updateTotals();
    }

    const tableBody = document.getElementById('tableBody');
    tableBody.addEventListener('click', function(e) {
        if (e.target.classList.contains('interactive-cell')) {
            if (e.target.getAttribute('contenteditable') === 'true') return;
            if (e.target.closest('tr').classList.contains('completed-row')) return;
            
            let textToCopy = e.target.innerText.replace(' /', '').trim();
            navigator.clipboard.writeText(textToCopy).then(() => {
                document.getElementById("toast").innerText = "âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!";
                showToast();
            });
        }
    });

    tableBody.addEventListener('dblclick', function(e) {
        if (e.target.classList.contains('interactive-cell')) {
            if (e.target.closest('tr').classList.contains('completed-row')) return;
            
            e.target.setAttribute('contenteditable', 'true');
            e.target.focus();
            document.execCommand('selectAll', false, null);
        }
    });

    tableBody.addEventListener('focusout', saveEdit);
    tableBody.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); }
    });

    function saveEdit(e) {
        if (e.target.classList.contains('interactive-cell') && e.target.getAttribute('contenteditable') === 'true') {
            e.target.setAttribute('contenteditable', 'false');
            updateTotals();
        }
    }

    function showToast() {
        const toast = document.getElementById("toast");
        toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
    }

    function deleteRow(btn) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) {
            btn.closest('tr').remove();
            updateTotals();
        }
    }

    function updateTotals() {
        let total = 0, count = 0;
        const amountCells = document.querySelectorAll('.amount-cell');
        amountCells.forEach(cell => {
            const row = cell.closest('tr');
            if (row.style.display !== 'none' && !row.classList.contains('completed-row')) {
                let val = parseFloat(cell.innerText.replace(/,/g, ''));
                if (!isNaN(val)) total += val;
                count++;
            }
        });
        document.getElementById('totalAmount').innerText = total.toLocaleString();
        document.getElementById('totalCount').innerText = count;
    }

    function filterTable() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.getElementById("tableBody").getElementsByTagName("tr");
        for (let i = 0; i < rows.length; i++) {
            let rowText = rows[i].innerText.toLowerCase();
            rows[i].style.display = rowText.includes(input) ? "" : "none";
        }
        updateTotals();
    }
    
    function exportTableToCSV() {
    // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ BOM Ù„Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (UTF-8) Ù„ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø¥ÙƒØ³Ù„
    let csv = '\uFEFF'; 
    const separator = ';'; // Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ù…Ù†Ù‚ÙˆØ·Ø© Ù„Ø¶Ù…Ø§Ù† ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    
    // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    const headers = ["Ø§Ù„Ù…Ø±Ø³Ù„", "Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨", "Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±Ø³Ù„", "Ø§Ù„Ù…Ø¨Ù„Øº", "Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„", "ØªÙ„ÙÙˆÙ† Ø§Ù„Ù…Ø³ØªÙ„Ù…", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª", "Ø§Ù„Ø­Ø§Ù„Ø©"];
    csv += headers.join(separator) + "\n";

    const rows = document.querySelectorAll("#resultTable tbody tr");
    
    // Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ ØµÙ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
    let fileNameSenderName = "ÙƒØ´Ù";
    let fileNameSenderAccount = "";
    let foundFirstRow = false;

    for (let i = 0; i < rows.length; i++) {
        if (rows[i].style.display === 'none') continue; // ØªØ®Ø·ÙŠ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø®ÙÙŠØ© Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«
        
        let rowData = [];
        let cols = rows[i].querySelectorAll("td");
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø£ÙˆÙ„ ØµÙ Ø¸Ø§Ù‡Ø± (Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ ÙˆØ±Ù‚Ù… Ø­Ø³Ø§Ø¨Ù‡)
        if (!foundFirstRow) {
            fileNameSenderName = cols[0].innerText.trim();
            fileNameSenderAccount = cols[1].innerText.replace(/\//g, '').trim(); // ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
            foundFirstRow = true;
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        for (let j = 0; j <= 6; j++) {
            if (cols[j]) {
                let text = cols[j].innerText.replace('ğŸ“‹', '').trim();
                
                // ğŸ›¡ï¸ [ØªØ¹Ø¯ÙŠÙ„ Ø£Ù…Ù†ÙŠ] Ù…Ù†Ø¹ Ø«ØºØ±Ø© Ø­Ù‚Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ (CSV Injection)
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ø«Ù„ = Ø£Ùˆ + Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø§Ù‚ØªØ¨Ø§Ø³ Ù…ÙØ±Ø¯Ø© Ù„ÙŠÙ‚Ø±Ø£Ù‡ Ø§Ù„Ø¥ÙƒØ³Ù„ ÙƒÙ†Øµ
                if (/^[=+\-@]/.test(text)) {
                    text = "'" + text;
                }
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù… 1)
                if (j === 1) { 
                    // Ø£ÙˆÙ„Ø§Ù‹: Ø­Ø°Ù Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ø§Ø¦Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± //
                    let cleanAcc = text.replace(/\//g, '').trim();
                    // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±
                    text = "/ " + cleanAcc; 
                }
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ ÙˆØªØ¬Ù‡ÙŠØ²Ù‡ Ù„Ù„Ø®Ù„Ø§ÙŠØ§
                rowData.push('"' + text.replace(/"/g, '""') + '"');
            }
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø© (ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ / Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±)
        const checkbox = cols[7].querySelector('input[type="checkbox"]');
        const status = checkbox && checkbox.checked ? "ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„" : "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
        rowData.push('"' + status + '"');

        csv += rowData.join(separator) + "\n";
    }
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: (Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ - Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ - Ø§Ù„ØªØ§Ø±ÙŠØ®)
    const today = new Date();
    const dateStr = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø£ÙŠ Ø±Ù…ÙˆØ² Ù‚Ø¯ ØªÙ…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸
    const safeSenderName = fileNameSenderName.replace(/[\\/:*?"<>|]/g, '');
    const finalFileName = `${safeSenderName} - ${fileNameSenderAccount} - ${dateStr}.csv`;

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.setAttribute("href", URL.createObjectURL(blob));
    link.setAttribute("download", finalFileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
</body>
</html>
